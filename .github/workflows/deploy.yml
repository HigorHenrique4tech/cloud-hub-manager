name: Deploy to Azure

on:
  workflow_run:
    workflows: ["Backend CI", "Frontend CI"]
    types: [completed]
    branches: [main]

env:
  ACR_REGISTRY: ${{ secrets.ACR_LOGIN_SERVER }}
  RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  APP_NAME: cloudatlas

jobs:
  deploy:
    name: Build, Push & Deploy
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'

    steps:
      - uses: actions/checkout@v4

      # ── Azure Login ────────────────────────────────────────────────────────
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # ── Login to Azure Container Registry ──────────────────────────────────
      - name: Login to ACR
        uses: azure/docker-login@v2
        with:
          login-server: ${{ secrets.ACR_LOGIN_SERVER }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      # ── Build & Push Backend ───────────────────────────────────────────────
      - name: Build & push backend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: infra/docker/backend.prod.Dockerfile
          push: true
          tags: |
            ${{ env.ACR_REGISTRY }}/cloudatlas-backend:${{ github.sha }}
            ${{ env.ACR_REGISTRY }}/cloudatlas-backend:latest

      # ── Build & Push Frontend ──────────────────────────────────────────────
      - name: Build & push frontend image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: infra/docker/frontend.prod.Dockerfile
          push: true
          tags: |
            ${{ env.ACR_REGISTRY }}/cloudatlas-frontend:${{ github.sha }}
            ${{ env.ACR_REGISTRY }}/cloudatlas-frontend:latest

      # ── Deploy to Azure App Service ────────────────────────────────────────
      - name: Deploy backend to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.APP_NAME }}-backend
          images: ${{ env.ACR_REGISTRY }}/cloudatlas-backend:${{ github.sha }}

      - name: Deploy frontend to Azure App Service
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.APP_NAME }}-frontend
          images: ${{ env.ACR_REGISTRY }}/cloudatlas-frontend:${{ github.sha }}

      # ── Logout ─────────────────────────────────────────────────────────────
      - name: Azure logout
        run: az logout
        if: always()
